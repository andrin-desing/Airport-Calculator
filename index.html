<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flugstart-Rechner</title>
    <!-- Tailwind CSS CDN für das Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* CSS-Variablen für die verschiedenen Themen */
        body[data-theme="lush"] {
            --color-bg: #253D2C;
            --color-container-bg: #68BA7F;
            --color-text: #253D2C;
            --color-title: #2E6F40;
            --color-accent: #2E6F40;
            --color-info-bg: #CFFFDC;
        }
        /* Die Textfarbe wurde für eine bessere Lesbarkeit auf Weiß geändert */
        body[data-theme="chili"] {
            --color-bg: #38000A;
            --color-container-bg: #CD1C18;
            --color-text: #ffffff; /* Geändert */
            --color-title: #9B1313;
            --color-accent: #9B1313;
            --color-info-bg: #FFA896;
        }
        /* Die Textfarbe wurde für eine bessere Lesbarkeit auf Weiß geändert */
        body[data-theme="stormy"] {
            --color-bg: #384959;
            --color-container-bg: #6A89A7;
            --color-text: #ffffff; /* Geändert */
            --color-title: #88BBDF;
            --color-accent: #88BBDF;
            --color-info-bg: #BDDDDF;
        }
        body[data-theme="mossy"] {
            --color-bg: #3C4430;
            --color-container-bg: #8C9B7E;
            --color-text: #3C4430;
            --color-title: #647257;
            --color-accent: #647257;
            --color-info-bg: #D7E0D0;
        }

        /* Dynamische Tailwind-Klassen basierend auf den CSS-Variablen */
        .bg-theme-bg { background-color: var(--color-bg); }
        .bg-theme-container { background-color: var(--color-container-bg); }
        .text-theme-text { color: var(--color-text); }
        .text-theme-title { color: var(--color-title); }
        .text-theme-accent { color: var(--color-accent); }
        .bg-theme-accent { background-color: var(--color-accent); }
        .bg-theme-info { background-color: var(--color-info-bg); }
        .border-theme-accent { border-color: var(--color-accent); }
        .focus-theme-accent:focus {
            --tw-ring-color: var(--color-accent);
            border-color: var(--color-accent);
        }
        .hover-bg-theme-accent:hover { background-color: var(--color-accent); }

        /* Allgemeine Styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        .search-results {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            color: #3D4127; /* Feste Farbe für Lesbarkeit */
        }
        #theme-switcher-dropdown {
            top: 4rem;
            left: 1rem;
        }
        .theme-button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        /* Styles für die Themenschaltflächen mit !important */
        #theme-chili { background-color: #CD1C18 !important; color: white; }
        #theme-lush { background-color: #2E6F40 !important; color: white; }
        #theme-stormy { background-color: #6A89A7 !important; color: white; }
        #theme-mossy { background-color: #647257 !important; color: white; }
        
        /* Neuer Stil für den runden Einstellungsbutton */
        #settings-btn {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-theme-bg flex items-center justify-center min-h-screen p-4">

    <!-- Einstellungsrad in der oberen linken Ecke -->
    <div class="absolute top-4 left-4 z-50">
        <button id="settings-btn" class="p-2 text-white bg-theme-accent rounded-full shadow-lg hover:rotate-45 transition-transform duration-300">
            <span class="material-icons">settings</span>
        </button>
        <!-- Dropdown-Menü für die Themenauswahl -->
        <div id="theme-switcher-dropdown" class="absolute hidden bg-white rounded-lg shadow-xl p-4 mt-2 w-40">
            <h3 class="text-sm font-bold text-gray-700 mb-2">Thema wählen</h3>
            <div class="space-y-2">
                <button id="theme-chili" class="theme-button w-full text-left">Chili Spice</button>
                <button id="theme-lush" class="theme-button w-full text-left">Lush Forest</button>
                <button id="theme-stormy" class="theme-button w-full text-left">Stormy Morning</button>
                <button id="theme-mossy" class="theme-button w-full text-left">Mossy Meadow</button>
            </div>
        </div>
    </div>

    <!-- Hauptcontainer für die Anwendung -->
    <div class="bg-theme-container p-8 rounded-2xl shadow-xl max-w-lg w-full transform transition-all duration-300">
        <h1 class="text-3xl font-bold text-center text-theme-title mb-6 flex items-center justify-center space-x-2">
            <span class="material-icons">flight_takeoff</span>
            <span>Flugstart-Rechner</span>
        </h1>
        <p class="text-center text-theme-text mb-8">
            Simulieren Sie die wichtigsten Startgeschwindigkeiten (V1, VR, V2) und die Abhebzeit.
            Die Berechnungen basieren auf vereinfachten Formeln.
        </p>
        
        <!-- Lade-Indikator während die Daten geladen werden -->
        <div id="loading-indicator" class="text-center py-4 text-theme-text hidden">
            <div class="flex items-center justify-center space-x-2">
                <div class="animate-spin h-5 w-5 border-4 border-theme-accent border-t-transparent rounded-full"></div>
                <span>Lade Flughafendaten...</span>
            </div>
        </div>

        <!-- Formular für die Eingaben -->
        <form id="calculatorForm" class="space-y-6">
            
            <!-- Eingabefeld für die Flugzeugsuche mit KI -->
            <div>
                <label for="aircraft_name_input" class="block text-sm font-medium text-theme-text">Flugzeugtyp suchen</label>
                <div class="mt-1 flex items-center space-x-2">
                    <input type="text" id="aircraft_name_input" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-theme-accent focus-theme-accent sm:text-sm p-3 bg-white text-gray-800" placeholder="z.B. Airbus A320">
                    <button type="button" id="search_aircraft_btn" class="px-4 py-2 bg-theme-accent text-white font-medium rounded-md shadow-sm hover-bg-theme-accent transition-colors">
                        Suchen
                    </button>
                </div>
            </div>

            <!-- Anzeige der von der KI gefundenen Daten -->
            <div id="ai_info_display" class="bg-theme-info p-3 rounded-lg shadow-sm hidden">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-sm font-medium text-theme-text">Flugzeugtyp:</span>
                    <span id="ai_model" class="text-theme-title font-bold"></span>
                </div>
                <div class="flex justify-between items-center mb-1">
                    <span class="text-sm font-medium text-theme-text">Maximales Startgewicht (MTOW):</span>
                    <span id="ai_mtow" class="text-theme-title font-bold"></span>
                </div>
                <div class="flex justify-between items-center mb-1">
                    <span class="text-sm font-medium text-theme-text">Triebwerksleistung (Schub):</span>
                    <span id="ai_engine_power" class="text-theme-title font-bold"></span>
                </div>
                <div class="flex justify-between items-center mb-1">
                    <span class="text-sm font-medium text-theme-text">Kraftstoffverbrauch (Fahrwerk ausgefahren):</span>
                    <span id="ai_fuel_with_gear" class="text-theme-title font-bold"></span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm font-medium text-theme-text">Kraftstoffverbrauch (Fahrwerk eingefahren):</span>
                    <span id="ai_fuel_without_gear" class="text-theme-title font-bold"></span>
                </div>
            </div>

            <!-- Eingabefeld für das Flugzeuggewicht -->
            <div>
                <label for="aircraft_weight" class="block text-sm font-medium text-theme-text">Flugzeuggewicht (in kg)</label>
                <div class="mt-1 relative rounded-md shadow-sm">
                    <input type="number" id="aircraft_weight" name="aircraft_weight" class="block w-full rounded-md border-gray-300 pl-3 pr-12 focus:border-theme-accent focus-theme-accent sm:text-sm p-3 bg-white text-gray-800" placeholder="z.B. 75000">
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                        <span class="text-gray-500 sm:text-sm">
                            kg
                        </span>
                    </div>
                </div>
            </div>

            <!-- Eingabefeld für die Flughafensuche -->
            <div>
                <label for="airport_search" class="block text-sm font-medium text-theme-text">Flughafen suchen</label>
                <div class="mt-1 relative">
                    <input type="text" id="airport_search" name="airport_search" class="block w-full rounded-md border-gray-300 pl-3 pr-12 focus:border-theme-accent focus-theme-accent sm:text-sm p-3 bg-white text-gray-800" placeholder="z.B. Frankfurt oder Berlin">
                    <!-- Container für die Suchergebnisse -->
                    <div id="airport-results" class="absolute z-10 w-full bg-white shadow-lg rounded-md mt-1 border border-gray-200 hidden search-results"></div>
                </div>
            </div>

            <!-- Eingabefeld für die Startbahnlänge -->
            <div>
                <label for="runway_length" class="block text-sm font-medium text-theme-text">Startbahnlänge (in m)</label>
                <div class="mt-1 relative rounded-md shadow-sm">
                    <input type="number" id="runway_length" name="runway_length" class="block w-full rounded-md border-gray-300 pl-3 pr-12 focus:border-theme-accent focus-theme-accent sm:text-sm p-3 bg-white text-gray-800" placeholder="z.B. 3000" readonly>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                        <span class="text-gray-500 sm:text-sm">
                            m
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Anzeige der automatisch geladenen Temperatur -->
            <div>
                <label class="block text-sm font-medium text-theme-text">Außentemperatur</label>
                <div class="mt-1 flex items-center justify-between bg-theme-info p-3 rounded-lg shadow-sm">
                    <span id="temp-display" class="font-bold text-theme-title">Wählen Sie einen Flughafen...</span>
                    <span id="temp-loading-spinner" class="animate-spin h-5 w-5 text-theme-title hidden">
                        <span class="material-icons">sync</span>
                    </span>
                </div>
            </div>

            <!-- Eingabefeld für die Höhe -->
            <div>
                <label for="altitude" class="block text-sm font-medium text-theme-text">Höhe (in m)</label>
                <div class="mt-1 relative rounded-md shadow-sm">
                    <input type="number" id="altitude" name="altitude" class="block w-full rounded-md border-gray-300 pl-3 pr-12 focus:border-theme-accent focus-theme-accent sm:text-sm p-3 bg-white text-gray-800" placeholder="z.B. 500" readonly>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                        <span class="text-gray-500 sm:text-sm">
                            m
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Schaltfläche für die Berechnung -->
            <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-theme-accent hover:bg-theme-title focus:outline-none focus:ring-2 focus:ring-offset-2 focus-theme-accent transition-colors duration-200 ease-in-out">
                Berechnen
            </button>
        </form>

        <!-- Bereich zur Anzeige der Ergebnisse -->
        <div id="results" class="mt-8 pt-6 border-t-2 border-gray-200 space-y-4 hidden">
            <h2 class="text-2xl font-semibold text-center text-theme-text">Ergebnisse</h2>
            <div class="space-y-2">
                <div class="flex justify-between items-center bg-theme-info p-3 rounded-lg shadow-sm">
                    <span class="font-medium text-theme-text">V1 (Entscheidungsgeschwindigkeit):</span>
                    <span id="v1-result" class="text-theme-title font-bold text-xl">-- km/h</span>
                </div>
                <div class="flex justify-between items-center bg-theme-info p-3 rounded-lg shadow-sm">
                    <span class="font-medium text-theme-text">VR (Rotationsgeschwindigkeit):</span>
                    <span id="vr-result" class="text-theme-title font-bold text-xl">-- km/h</span>
                </div>
                <div class="flex justify-between items-center bg-theme-info p-3 rounded-lg shadow-sm">
                    <span class="font-medium text-theme-text">V2 (Sichere Startsteiggeschwindigkeit):</span>
                    <span id="v2-result" class="text-theme-title font-bold text-xl">-- km/h</span>
                </div>
                <div class="flex justify-between items-center bg-theme-info p-3 rounded-lg shadow-sm">
                    <span class="font-medium text-theme-text">Abhebzeit:</span>
                    <span id="takeoff-time-result" class="text-theme-title font-bold text-xl">-- s</span>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript für die Berechnungs- und Themenlogik -->
    <script>
        const OPENWEATHERMAP_API_KEY = "d5f7c01fccc6586a908135deb9969a61";

        let currentTemp = null; 
        let combinedAirportData = {};
        let maxTakeoffWeight = null; // Speichert das von der KI gefundene MTOW

        const airportSearchInput = document.getElementById('airport_search');
        const airportResultsDiv = document.getElementById('airport-results');
        const runwayInput = document.getElementById('runway_length');
        const altitudeInput = document.getElementById('altitude');
        const tempDisplay = document.getElementById('temp-display');
        const tempLoadingSpinner = document.getElementById('temp-loading-spinner');
        const loadingIndicator = document.getElementById('loading-indicator');
        const form = document.getElementById('calculatorForm');

        const aircraftNameInput = document.getElementById('aircraft_name_input');
        const searchAircraftBtn = document.getElementById('search_aircraft_btn');
        const aiInfoDisplay = document.getElementById('ai_info_display');
        const aiModelSpan = document.getElementById('ai_model');
        const aiMtowSpan = document.getElementById('ai_mtow');
        const aiEnginePowerSpan = document.getElementById('ai_engine_power');
        const aiFuelWithGearSpan = document.getElementById('ai_fuel_with_gear');
        const aiFuelWithoutGearSpan = document.getElementById('ai_fuel_without_gear');
        const aircraftWeightInput = document.getElementById('aircraft_weight');
        
        const settingsBtn = document.getElementById('settings-btn');
        const themeDropdown = document.getElementById('theme-switcher-dropdown');

        /**
         * Ruft die CSV-Dateien ab, parst sie und kombiniert die Daten.
         */
        async function loadData() {
            loadingIndicator.classList.remove('hidden');
            form.classList.add('hidden');
            
            try {
                // Fetch and parse airports.csv
                const airportsResponse = await fetch('airports.csv');
                const airportsText = await airportsResponse.text();
                const airports = parseCSV(airportsText);
                
                // Fetch and parse runways.csv
                const runwaysResponse = await fetch('runways.csv');
                const runwaysText = await runwaysResponse.text();
                const runways = parseCSV(runwaysText);
                
                // Kombinieren der Flughafendaten
                const runwaysMap = new Map();
                runways.forEach(r => {
                    const length_ft = parseFloat(r.length_ft);
                    if (!isNaN(length_ft)) {
                         // Finden Sie die längste Startbahn für jeden Flughafen
                        if (!runwaysMap.has(r.airport_ident) || runwaysMap.get(r.airport_ident) < length_ft) {
                            runwaysMap.set(r.airport_ident, length_ft);
                        }
                    }
                });

                // Kombinieren von Flughäfen und Startbahnen
                airports.forEach(a => {
                    const icao_code = a.icao_code.toUpperCase();
                    const runwayLengthFt = runwaysMap.get(icao_code);
                    const altitude_ft = parseFloat(a.elevation_ft);
                    
                    if (runwayLengthFt && !isNaN(altitude_ft)) {
                        // Konvertieren von Fuß in Meter (1 ft = 0.3048 m)
                        const runwayLengthM = (runwayLengthFt * 0.3048).toFixed(0);
                        const altitudeM = (altitude_ft * 0.3048).toFixed(0);
                        
                        combinedAirportData[icao_code] = {
                            name: a.name,
                            runway_length: runwayLengthM,
                            altitude: altitudeM,
                            city: a.municipality,
                            country: a.iso_country
                        };
                    }
                });
                
                loadingIndicator.classList.add('hidden');
                form.classList.remove('hidden');
                console.log('Alle Daten erfolgreich geladen und verarbeitet.');

            } catch (error) {
                console.error('Fehler beim Laden der CSV-Daten:', error);
                displayMessage('Fehler beim Laden der Flughafendaten. Bitte versuchen Sie es erneut.');
                loadingIndicator.classList.add('hidden');
            }
        }
        
        // Einfacher CSV-Parser
        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.replace(/"/g, ''));
            return lines.slice(1).map(line => {
                const values = line.split(',').map(v => v.replace(/"/g, ''));
                return headers.reduce((obj, header, index) => {
                    obj[header] = values[index];
                    return obj;
                }, {});
            });
        }

        /**
         * Ruft die aktuelle Temperatur für den ausgewählten Flughafen ab.
         * @param {object} airport - Das Flughafenobjekt mit Stadt und Land.
         */
        async function fetchTemperature(airport) {
            tempDisplay.textContent = 'Lädt...';
            tempLoadingSpinner.classList.remove('hidden');

            const apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=${airport.city},${airport.country}&appid=${OPENWEATHERMAP_API_KEY}&units=metric`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`API Fehler: ${response.statusText}`);
                }
                const data = await response.json();
                
                // Überprüfen, ob die Datenstruktur korrekt ist
                if (data && data.main && data.main.temp) {
                    currentTemp = data.main.temp;
                    tempDisplay.textContent = `${currentTemp.toFixed(1)} °C`;
                } else {
                    throw new Error('Ungültige API-Antwort.');
                }
            } catch (error) {
                console.error('Fehler beim Abrufen der Temperatur:', error);
                displayMessage(`Temperatur konnte nicht geladen werden: ${error.message}`);
                tempDisplay.textContent = 'Fehler beim Laden';
                currentTemp = null;
            } finally {
                tempLoadingSpinner.classList.add('hidden');
            }
        }

        /**
         * Sucht mit der KI nach Flugzeugdaten und dem maximalen Startgewicht.
         * @param {string} aircraftName - Der Name des zu suchenden Flugzeugs.
         */
        async function searchAircraftWithAI(aircraftName) {
            if (!aircraftName) {
                displayMessage('Bitte geben Sie einen Flugzeugnamen ein.');
                return;
            }

            // UI-Feedback für den Ladevorgang
            searchAircraftBtn.disabled = true;
            searchAircraftBtn.textContent = 'Suchen...';
            aiInfoDisplay.classList.add('hidden');
            aircraftWeightInput.value = '';
            maxTakeoffWeight = null;

            let retryCount = 0;
            const maxRetries = 3;
            let delay = 1000; // 1 second delay
            
            while (retryCount < maxRetries) {
                try {
                    // Der aktualisierte Prompt weist die KI an, die Informationen von Wikipedia zu finden.
                    // Er fragt auch nach neuen Feldern.
                    const prompt = `Finden Sie auf der Wikipedia-Seite für das Flugzeug "${aircraftName}" die folgenden Informationen und geben Sie sie als JSON-Objekt zurück: 
                                    - maximales Startgewicht (MTOW) in kg
                                    - Triebwerksleistung (Schub) in lbs (Pfund)
                                    - Kraftstoffverbrauch (mit ausgefahrenem Fahrwerk) in Litern pro Stunde
                                    - Kraftstoffverbrauch (mit eingefahrenem Fahrwerk) in Litern pro Stunde
                                    Wenn Sie eine Information nicht finden können, setzen Sie den Wert auf -1. Beispiel für die Ausgabe: {"model": "Airbus A320", "mtow_kg": 78000, "engine_power_lbs": 27000, "fuel_consumption_with_gear_l_per_hour": 5000, "fuel_consumption_without_gear_l_per_hour": 3000}`;
                    
                    const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = {
                        contents: chatHistory,
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    "model": { "type": "STRING" },
                                    "mtow_kg": { "type": "NUMBER" },
                                    "engine_power_lbs": { "type": "NUMBER" },
                                    "fuel_consumption_with_gear_l_per_hour": { "type": "NUMBER" },
                                    "fuel_consumption_without_gear_l_per_hour": { "type": "NUMBER" }
                                }
                            }
                        }
                    };
                    const apiKey = "AIzaSyBH1jxoVg6mkk1H4RGBMxtI_YqCU-u1fZQ";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                         if (response.status === 429) {
                            // Too Many Requests, try again with exponential backoff
                            throw new Error('API limit reached. Retrying...');
                        }
                        throw new Error(`API-Fehler: ${response.statusText}`);
                    }

                    const result = await response.json();
                    const json = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    const parsedJson = JSON.parse(json);

                    if (parsedJson && parsedJson.mtow_kg && parsedJson.mtow_kg !== -1) {
                        aiModelSpan.textContent = parsedJson.model;
                        aiMtowSpan.textContent = `${parsedJson.mtow_kg.toLocaleString()} kg`;
                        aircraftWeightInput.value = parsedJson.mtow_kg;
                        maxTakeoffWeight = parsedJson.mtow_kg;
                        
                        // Setzen der neuen Datenfelder
                        aiEnginePowerSpan.textContent = parsedJson.engine_power_lbs !== -1 ? `${parsedJson.engine_power_lbs.toLocaleString()} lbs` : 'Nicht verfügbar';
                        aiFuelWithGearSpan.textContent = parsedJson.fuel_consumption_with_gear_l_per_hour !== -1 ? `${parsedJson.fuel_consumption_with_gear_l_per_hour.toLocaleString()} L/h` : 'Nicht verfügbar';
                        aiFuelWithoutGearSpan.textContent = parsedJson.fuel_consumption_without_gear_l_per_hour !== -1 ? `${parsedJson.fuel_consumption_without_gear_l_per_hour.toLocaleString()} L/h` : 'Nicht verfügbar';

                        aiInfoDisplay.classList.remove('hidden');
                        displayMessage(`Daten für ${parsedJson.model} gefunden.`);
                    } else {
                        displayMessage('Keine Daten für dieses Flugzeug gefunden.');
                        aiInfoDisplay.classList.add('hidden');
                    }
                    
                    // Exit the loop on success
                    break; 

                } catch (error) {
                    console.error('Fehler bei der KI-Suche:', error);
                    retryCount++;
                    if (retryCount >= maxRetries) {
                        displayMessage('Fehler bei der KI-Suche. Bitte versuchen Sie es manuell oder später erneut.');
                    } else {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    }
                }
            }
            
            // UI-Feedback zurücksetzen
            searchAircraftBtn.disabled = false;
            searchAircraftBtn.textContent = 'Suchen';
        }


        // Event-Listener für die Flughafensuche
        airportSearchInput.addEventListener('input', function() {
            const query = this.value.toLowerCase();
            airportResultsDiv.innerHTML = ''; // Vorherige Ergebnisse leeren

            if (query.length > 1) {
                const filteredAirports = Object.keys(combinedAirportData).filter(key => 
                    combinedAirportData[key].name.toLowerCase().includes(query) || key.toLowerCase().includes(query)
                );

                if (filteredAirports.length > 0) {
                    airportResultsDiv.classList.remove('hidden');
                    filteredAirports.slice(0, 10).forEach(key => {
                        const airport = combinedAirportData[key];
                        const resultItem = document.createElement('div');
                        resultItem.textContent = `${airport.name} (${key})`;
                        resultItem.className = 'p-2 cursor-pointer bg-white text-gray-800 hover:bg-theme-info transition-colors duration-150';
                        resultItem.dataset.key = key; // Speichere den Schlüssel
                        
                        // Klick-Handler für das Suchergebnis
                        resultItem.addEventListener('click', () => {
                            runwayInput.value = airport.runway_length;
                            altitudeInput.value = airport.altitude;
                            airportSearchInput.value = `${airport.name} (${key})`; // Setze den Namen im Suchfeld
                            airportResultsDiv.classList.add('hidden'); // Ergebnisse ausblenden
                            
                            // Rufe die Temperatur für den ausgewählten Flughafen ab
                            fetchTemperature(airport);
                        });
                        airportResultsDiv.appendChild(resultItem);
                    });
                } else {
                    airportResultsDiv.classList.add('hidden');
                }
            } else {
                airportResultsDiv.classList.add('hidden');
            }
        });
        
        // Klick-Handler außerhalb der Ergebnisliste, um sie zu schließen
        document.addEventListener('click', function(event) {
            if (!airportSearchInput.contains(event.target) && !airportResultsDiv.contains(event.target)) {
                airportResultsDiv.classList.add('hidden');
            }
        });
        
        // Event-Listener für den neuen KI-Such-Button
        searchAircraftBtn.addEventListener('click', () => {
            const aircraftName = aircraftNameInput.value;
            searchAircraftWithAI(aircraftName);
        });

        // Event-Listener für das Berechnungsformular
        document.getElementById('calculatorForm').addEventListener('submit', function(event) {
            event.preventDefault(); // Verhindert das Neuladen der Seite
            
            // Holen der Werte aus den Eingabefeldern
            const weight = parseFloat(document.getElementById('aircraft_weight').value);
            const runwayLength = parseFloat(document.getElementById('runway_length').value);
            const altitude = parseFloat(document.getElementById('altitude').value);

            // Überprüfen, ob alle Werte gültig sind und die Temperatur geladen wurde
            if (isNaN(weight) || isNaN(runwayLength) || isNaN(altitude) || currentTemp === null) {
                const errorMessage = 'Bitte geben Sie gültige Werte in alle Felder ein und wählen Sie einen Flughafen, um die Temperatur zu laden.';
                displayMessage(errorMessage);
                return;
            }

            // Zusätzliche Logik: Überprüfung, ob das eingegebene Gewicht das MTOW überschreitet
            if (maxTakeoffWeight && weight > maxTakeoffWeight) {
                displayMessage(`Achtung: Das eingegebene Gewicht (${weight} kg) ist größer als das maximale Startgewicht (${maxTakeoffWeight} kg)!`);
                return; 
            }

            // --- Vereinfachte Berechnungslogik (NICHT für den realen Einsatz!) ---
            // Einflussfaktoren:
            // - Höheres Gewicht -> höhere Geschwindigkeiten
            // - Höhere Temperatur und Höhe -> geringere Luftdichte -> längerer Startlauf und höhere Geschwindigkeiten
            
            // Grundgeschwindigkeiten basierend auf dem Gewicht
            const baseSpeed = 100 + (weight / 1000) * 0.5; // Vereinfachte Basisgeschwindigkeit in km/h

            // Korrekturfaktoren für Temperatur und Höhe
            const tempFactor = 1 + (currentTemp - 15) * 0.002; // Annahme: Standardtemperatur ist 15°C
            const altitudeFactor = 1 + (altitude / 1000) * 0.005; // Annahme: Standardhöhe ist 0m

            // Berechnungen der V-Geschwindigkeiten
            const v1 = baseSpeed * tempFactor * altitudeFactor * 0.95;
            const vr = baseSpeed * tempFactor * altitudeFactor * 1.0;
            const v2 = baseSpeed * tempFactor * altitudeFactor * 1.05;

            // Vereinfachte Abhebzeit-Berechnung (Annahme: konstante Beschleunigung)
            // Umrechnung von km/h in m/s
            const vr_ms = (vr * 1000) / 3600; 
            // Angenommene Beschleunigung basierend auf dem Gewicht
            const acceleration = 10 - (weight / 100000) * 2; // Vereinfachte Formel
            const takeoffTime = vr_ms / acceleration;

            // Hinzugefügte Logik: Überprüfung, ob die Startbahn ausreicht
            // Die benötigte Startdistanz wird als halbe Strecke bei konstanter Beschleunigung berechnet
            const requiredDistance = 0.5 * vr_ms * takeoffTime;
            
            if (requiredDistance > runwayLength) {
                displayMessage('Startbahn nicht ausreichend!');
                return;
            }

            // Ergebnisse auf zwei Dezimalstellen runden
            const v1Rounded = v1.toFixed(2);
            const vrRounded = vr.toFixed(2);
            const v2Rounded = v2.toFixed(2);
            const takeoffTimeRounded = takeoffTime.toFixed(2);

            // Ergebnisse im HTML-Dokument anzeigen
            document.getElementById('v1-result').textContent = `${v1Rounded} km/h`;
            document.getElementById('vr-result').textContent = `${vrRounded} km/h`;
            document.getElementById('v2-result').textContent = `${v2Rounded} km/h`;
            document.getElementById('takeoff-time-result').textContent = `${takeoffTimeRounded} s`;
            
            // Den Ergebnisbereich einblenden
            document.getElementById('results').classList.remove('hidden');
        });
        
        // Funktion zur Anzeige von Nachrichten (ersetzt alert())
        function displayMessage(message) {
            let messageBox = document.getElementById('message-box');
            if (!messageBox) {
                messageBox = document.createElement('div');
                messageBox.id = 'message-box';
                messageBox.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 p-4 bg-red-500 text-white rounded-lg shadow-lg z-50 transition-opacity duration-300';
                document.body.appendChild(messageBox);
            }
            messageBox.textContent = message;
            messageBox.style.opacity = '1';
            setTimeout(() => {
                messageBox.style.opacity = '0';
            }, 3000);
        }

        // --- Themenwechsel-Logik ---
        const themes = {
            'lush': {
                bg: '#253D2C', container: '#68BA7F', text: '#253D2C', title: '#2E6F40', accent: '#2E6F40', info: '#CFFFDC'
            },
            'chili': {
                bg: '#38000A', container: '#CD1C18', text: '#ffffff', title: '#9B1313', accent: '#9B1313', info: '#FFA896'
            },
            'stormy': {
                bg: '#384959', container: '#6A89A7', text: '#ffffff', title: '#88BBDF', accent: '#88BBDF', info: '#BDDDDF'
            },
            'mossy': {
                bg: '#3C4430', container: '#8C9B7E', text: '#3C4430', title: '#647257', accent: '#647257', info: '#D7E0D0'
            }
        };

        function applyTheme(themeName) {
            document.body.dataset.theme = themeName;
            localStorage.setItem('selectedTheme', themeName);
        }

        function toggleThemeDropdown() {
            themeDropdown.classList.toggle('hidden');
        }

        // Event-Listener für den Einstellungs-Button
        settingsBtn.addEventListener('click', toggleThemeDropdown);
        
        // Event-Listener für die Themen-Buttons
        document.getElementById('theme-chili').addEventListener('click', () => applyTheme('chili'));
        document.getElementById('theme-lush').addEventListener('click', () => applyTheme('lush'));
        document.getElementById('theme-stormy').addEventListener('click', () => applyTheme('stormy'));
        document.getElementById('theme-mossy').addEventListener('click', () => applyTheme('mossy'));

        // Schließen des Dropdowns bei Klick außerhalb
        document.addEventListener('click', function(event) {
            if (!settingsBtn.contains(event.target) && !themeDropdown.contains(event.target)) {
                themeDropdown.classList.add('hidden');
            }
        });

        // Beim Laden der Seite das gespeicherte Thema anwenden
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('selectedTheme') || 'lush'; // Standardthema ist Lush
            applyTheme(savedTheme);
            loadData();
        });
    </script>
</body>
</html>

